<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .order-form-card {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            background-color: #ffffff;
            padding: 2rem;
        }
        .product-item {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: #f0f8ff;
        }
        .total-box {
            background-color: #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .service-box {
            background-color: #fff3cd;
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #ffecb5;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
        <div class="container-fluid">
            
            <a class="navbar-brand" href="index">Dom Pedro Burguer's</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#navbarNav" aria-controls="navbarNav" 
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/pages/cad-pedido">Novo Pedido</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/pages/cardapio">Acessar Cardápio</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/pages/gerenciar-produtos">Gerenciar Produtos</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/pages/gerenciar-clientes">Gerenciar Clientes</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/pages/tipos-pagamento">Formas de Pagamento</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/pages/relatorio-vendas">Relatório de Vendas</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="order-form-card">
                    <h2 class="text-center mb-4 text-primary"><i class="bi bi-cart-plus-fill me-2"></i> Inserir Novo Pedido</h2>
                    
                    <form id="orderForm" method="POST" action="/pages/cad-pedido">
                        
                        <div class="row mb-4 align-items-center">
                            
                            <div class="col-md-6">
                                <label for="dataHoraPedido" class="form-label">Data e Hora do Pedido</label>
                                <input type="datetime-local" class="form-control" id="dataHoraPedido" name="dataHoraPedido" required>
                            </div>

                            <div class="col-md-6">
                                <div class="service-box">
                                    <label class="form-label d-block fw-bold text-dark mb-2">Tipo de Serviço</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="tipoServico" id="entrega" value="true" onchange="alternarCamposEndereco()" checked>
                                        <label class="form-check-label" for="entrega">
                                            <i class="bi bi-geo-alt-fill me-1 text-success"></i> Entrega
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="tipoServico" id="retirada" value="false" onchange="alternarCamposEndereco()">
                                        <label class="form-check-label" for="retirada">
                                            <i class="bi bi-bag-check-fill me-1 text-info"></i> Retirada
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>
                        
                        <h4 class="mb-3 text-secondary"><i class="bi bi-person-lines-fill me-2"></i>Dados do Cliente</h4>

                        <div class="row mb-3">
                            <div class="col-md-7">
                                <label for="nomeCliente" class="form-label">Nome do Cliente</label>
                                
                                <select class="form-select" id="nomeCliente" name="clienteId" required onchange="preencherDadosCliente()">
                                    
                                    <option value="" selected disabled>-- Selecione o Cliente --</option>
                                    
                                    <#list clientes as cliente>
                                        <option 
                                            value="${cliente.id}" 
                                            data-telefone="${cliente.telefone!}" 
                                            data-endereco="${cliente.endereco!}"
                                            data-complemento="${cliente.complemento!}">
                                            ${cliente.nome}
                                        </option>
                                    </#list>
                                    
                                </select>
                                
                            </div>
                            <div class="col-md-5">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" placeholder="Ex: (99) 99999-9999" required readonly>
                            </div>
                        </div>

                        <div id="camposEndereco" class="row mb-4">
                            <div class="col-md-8">
                                <label for="enderecoEntrega" class="form-label">Endereço de Entrega</label>
                                <input type="text" class="form-control" id="enderecoEntrega" placeholder="Rua, número, bairro" required>
                            </div>
                            <div class="col-md-4">
                                <label for="complemento" class="form-label">Complemento</label>
                                <input type="text" class="form-control" id="complemento" placeholder="Apto, bloco, referência">
                            </div>

                            <div class="col-12 mt-3">
                                <label for="observacaoEntrega" class="form-label"><i class="bi "></i> Observação Adicional para a Entrega</label>
                                <textarea class="form-control" id="observacaoEntrega" rows="2" placeholder="Ex: Deixar na portaria, Cuidado com o cachorro, Ligar antes de subir."></textarea>
                            </div>
                        </div>

                        <hr>
                        
                        <h4 class="mb-3 text-secondary"><i class="bi bi-box-seam-fill me-2"></i>Itens do Pedido</h4>
                        
                        <#assign opcoesBrutas>
                            <option value="" data-valor="0.00" data-nome="">-- Selecione o Produto --</option>
                            <#list produtos as produto>
                                <option 
                                    value="${produto.id}" 
                                    data-valor="${produto.valor?string['0.00']}"
                                    data-nome="${produto.nome}">
                                    ${produto.nome}
                                </option>
                            </#list>
                        </#assign>

                        <#assign opcoesProdutosHtmlFinal = opcoesBrutas?trim?replace('\n', '')?replace('\r', '')>

                        <input 
                            type="hidden" 
                            id="opcoesProdutosTemplate" 
                            value="${opcoesProdutosHtmlFinal?html}">

                        <!-- Para o controller -->
                        <div class="mb-3 d-flex gap-2 align-items-end">
                            <div style="width: 40%;">
                                <label for="produtoSelect" class="form-label">Produto</label>
                                <select id="produtoSelect" class="form-select" onchange="atualizarValorProdutoVisivel()">
                                    <option value="" data-valor="0.00" data-nome="">-- Selecione o Produto --</option>
                                    <#list produtos as produto>
                                        <option 
                                            value="${produto.id}" 
                                            data-valor="${produto.valor?string['0.00']}"
                                            data-nome="${produto.nome}">
                                            ${produto.nome}
                                        </option>
                                    </#list>
                                </select>
                            </div>

                            <div style="width: 15%;">
                                <label for="quantidadeProdutoVisivel" class="form-label">Quantidade</label>
                                <input type="number" id="quantidadeProdutoVisivel" class="form-control" value="1" min="1">
                            </div>

                            <div style="width: 20%;">
                                <label for="valorProdutoVisivel" class="form-label">Valor</label>
                                <input type="text" id="valorProdutoVisivel" class="form-control" readonly value="R$ 0.00">
                            </div>

                            <button type="button" class="btn btn-outline-primary" onclick="adicionarProdutoFromSelect()">
                                <i class="bi bi-plus-circle-fill me-1"></i> Adicionar
                            </button>
                        </div>
                        <hr>
                        
                        <h4 class="mb-3 text-secondary"><i class="bi bi-wallet-fill me-2"></i>Forma de Pagamento</h4>

                        <div class="mb-4 d-flex gap-2 align-items-end">
                            <div style="width: 50%;">
                                <label for="formaPagamento" class="form-label fw-bold">Pagamento</label>
                                <select class="form-select" id="formaPagamento" name="formaPagamento" required>
                                    <option value="" selected disabled>-- Selecione a forma de pagamento --</option>
                                    <#list pagamento as pag>
                                        <option value="${pag.id}">
                                            ${pag.descricao}
                                        </option>
                                    </#list>
                                </select>
                            </div>
                        </div>
                        <h4 class="mb-3 text-secondary"><i class="bi bi-currency-dollar me-2"></i>Resumo Financeiro</h4>

                        <div class="row mb-3 justify-content-end">
                            <div class="col-md-6 col-lg-4">
                                <label for="valorTotal" class="form-label">Valor Total dos Produtos</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="valorTotal" value="0.00" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3 justify-content-end">
                            <div class="col-md-6 col-lg-4">
                                <label for="cupomDesconto" class="form-label">Código do Cupom de Desconto</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-ticket-fill"></i></span>
                                    <input type="text" class="form-control" id="cupomDesconto" placeholder="Ex: PROMO10" oninput="validarCupom()">
                                </div>
                                <small id="cupomHelp" class="form-text text-muted">Digite o código do cupom (Ex: PROMO10) e o desconto será aplicado.</small>
                            </div>
                        </div>
                        
                        <input type="hidden" id="valorDescontoAplicado" value="0.00">
                        
                        <div class="row mb-4 justify-content-end">
                            <div class="col-md-6 col-lg-4">
                                <div class="total-box text-end">
                                    <label class="mb-0">Valor Final a Pagar</label>
                                    <div class="h3 mb-0 text-success">R$ <span id="valorFinalDisplay">0.00</span></div>
                                    <input type="hidden" id="valorFinal" value="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle-fill me-2"></i> Finalizar e Salvar Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Atualiza o campo de valor visível quando muda a seleção no select
        function atualizarValorProdutoVisivel() {
            const sel = document.getElementById('produtoSelect');
            const opt = sel.options[sel.selectedIndex];
            const valor = opt.getAttribute('data-valor') || '0.00';
            document.getElementById('valorProdutoVisivel').value = 'R$ ' + parseFloat(valor).toFixed(2);
        }

        // Usa a opção selecionada no select visível para atualizar o template
        // oculto (`opcoesProdutosTemplate`) e reaproveitar a função existente
        // `adicionarProduto()` que já consome esse template.
        function adicionarProdutoFromSelect() {
            const sel = document.getElementById('produtoSelect');
            if (!sel) return;
            const opt = sel.options[sel.selectedIndex];
            if (!opt || !opt.value) {
                alert('Por favor selecione um produto antes de adicionar.');
                return;
            }

            // Atualiza o template oculto com apenas a opção selecionada
            const hidden = document.getElementById('opcoesProdutosTemplate');
            if (!hidden) return;
            hidden.value = opt.outerHTML;

            // Pega a quantidade do input visível
            const quantidadeInput = document.getElementById('quantidadeProdutoVisivel');
            const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) || 1 : 1;

            // Chama a função existente que insere o bloco do produto
            if (typeof adicionarProdutoComQtd === 'function') {
                adicionarProdutoComQtd(quantidade);
            } else if (typeof adicionarProduto === 'function') {
                adicionarProduto();
            } else {
                alert('Função adicionarProduto() não encontrada. Verifique o script principal.');
            }

            // Reseta o select, a quantidade e o valor visível
            sel.selectedIndex = 0;
            document.getElementById('quantidadeProdutoVisivel').value = '1';
            document.getElementById('valorProdutoVisivel').value = 'R$ 0.00';
        }
    </script>
    <script src="../JS/script.js"></script>
</body>
</html>